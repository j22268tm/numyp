# セッション管理機能の実装

## 概要
このドキュメントでは、アプリの再起動後もログイン状態を保持するためのセッション管理機能について説明します。

## 実装内容

### 1. セッショントークンの永続化

#### 追加されたパッケージ
- `flutter_secure_storage: ^9.2.2` - トークンを安全にデバイスに保存するためのパッケージ

#### 新規作成ファイル

##### `lib/services/session_storage.dart`
セッショントークンを安全に保存・取得・削除するサービスクラス。

主なメソッド:
- `saveToken(String token)` - トークンを保存
- `getToken()` - 保存されたトークンを取得
- `clearToken()` - トークンを削除
- `clearAll()` - すべてのデータを削除

##### `lib/providers/session_storage_provider.dart`
SessionStorageのRiverpodプロバイダー。アプリ全体でSessionStorageのインスタンスを共有します。

### 2. 認証フローの更新

#### `lib/providers/auth_provider.dart`
AuthNotifierクラスを更新し、以下の機能を追加:

1. **ログイン時の動作**
   - ログイン成功後、アクセストークンをSessionStorageに保存
   
2. **ログアウト時の動作**
   - 保存されたトークンをクリア
   - 認証状態をリセット

3. **セッション復元機能**
   - `restoreSession()` メソッドを追加
   - 保存されたトークンを使用してユーザー情報を取得
   - トークンが無効または期限切れの場合は自動的にクリア

### 3. アプリ起動時の処理

#### `lib/main.dart`
アプリ起動時に以下の処理を実行:

1. セッション復元を試行
2. セッション復元に失敗した場合、デバッグモードであれば自動ログイン
3. セッション復元に成功した場合、ログイン画面をスキップしてマップ画面を表示

### 4. ログアウト処理の更新

#### `lib/screens/mypage/mypage_screen.dart`
- ログアウトボタンの処理を非同期に変更（`await`を追加）

## 使用方法

### 通常の使用フロー

1. **初回ログイン**
   - ユーザーがログイン
   - アクセストークンが自動的にデバイスに保存される

2. **アプリの再起動**
   - アプリ起動時に自動的にセッションが復元される
   - ユーザーは再度ログインする必要なし

3. **ログアウト**
   - マイページからログアウトボタンをタップ
   - 保存されたトークンが削除される
   - 次回起動時にはログイン画面が表示される

## セキュリティ

- `flutter_secure_storage`を使用してトークンを暗号化して保存
- 各プラットフォームのセキュアストレージを利用:
  - iOS: Keychain
  - Android: EncryptedSharedPreferences
  - その他のプラットフォームも対応

## テスト

`test/services/session_storage_test.dart`にSessionStorageの単体テストを実装しています。

テストケース:
- トークンの保存
- トークンの取得
- トークンの削除
- トークンの上書き
- すべてのデータのクリア

## 注意事項

1. **トークンの有効期限**
   - バックエンドAPIがトークンの有効期限を管理している場合、期限切れトークンは自動的にクリアされます

2. **デバッグモード**
   - DEBUG=trueの場合、セッション復元に失敗すると自動的にテストユーザーでログインします

3. **プラットフォーム互換性**
   - flutter_secure_storageは主要なプラットフォーム（iOS、Android、Web、Desktop）をサポートしています
